parameters:
- name: name
  type: string
- name: vmImage
  type: string

jobs:
- job: ${{parameters.name}}
  timeoutInMinutes: 15

  pool:
    vmImage: ${{parameters.vmImage}}

  steps:
  - task: Npm@1
    inputs:
      command: 'install'
      workingDir: 'Tests'
    displayName: 'Install NPM packages'

  - bash: |
      $ANDROID_HOME\emulator\emulator -list-avds
      echo "y" | $ANDROID_HOME\tools\bin\sdkmanager --install "system-images;android-30;google_apis;x86"
      echo "no" | $ANDROID_HOME\tools\bin\avdmanager create avd -n android_api_30 -k "system-images;android-30;google_apis;x86" --force
      $ANDROID_HOME\emulator\emulator -list-avds
    displayName: Install Android Emulator

  - bash: |
      $ANDROID_HOME\emulator\emulator -list-avds
      $ANDROID_HOME\emulator\emulator -avd android_api_30 -no-snapshot
    displayName: Start Android Emulator

      # $ANDROID_HOME\platform-tools\adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'
      # $ANDROID_HOME\platform-tools\adb devices

  - task: Gradle@3
    inputs:
      gradleWrapperFile: 'Tests/UnitTests/Android/gradlew'
      workingDirectory: 'Tests/UnitTests/Android'
      tasks: 'connectedAndroidTest'
      jdkVersionOption: 1.11
    displayName: Run Connected Android Test

  - script: |
      adb logcat -s "JsRuntimeHost" -d
    displayName: Dump logcat

